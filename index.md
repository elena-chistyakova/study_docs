# study_docs
# Отправка чека в систему лояльности по факту получения счетом признака полной оплаты
Если в МО фискальный чек оплаты должен отправляться в систему лояльности по факту получения счетом признака полной оплаты (то есть фискальный чек может собираться из нескольких "чеков" МИС), то в этом случае требуется выполнить дополнительные настройки для корректного взаимодействия с внешней системой лояльности.
1. В каталоге базы данных МИС МЕДИАЛОГ, в файле Automedi.ver (или Аutomedi.ini), в секции [TROUBLES], необходимо добавить включенный параметр TROUBLES_OFF_CSB_LOYALTY: 

'''
[TROUBLES]
TROUBLES_OFF_CSB_LOYALTY=1
'''

2. Далее необходимо убедится, что для таблицы FM_INVOICE установлен триггер на обновление FM_INVOICE_IS_PAYFUL_ML. Когда счет будет полностью оплачен и все чеки по оплате счета получат финальный статус Проведен или Без кассы, данный триггер направит задание на сбор и обработку фискальных чеков оплаты для отправки в систему лояльности.
3.	Проверить наличие плагина **ManzanaTrigger**.
4.	При необходимости, в системном параметре **MANZANA_TRIGGER_DELAY_SEC** (пункт меню **Настройка / Системные параметры**), можно настроить время задержки (в сек) перед постановкой триггером задания на проведение чека лояльности в плагин **ManzanaTrigger**. Задержка задается  на случай, если из-за особенностей мощности оборудования АРМ кассира и сервера возникнет ситуация, когда триггер FM_INVOICE_IS_PAYFUL_ML отработает раньше, чем создание чека лояльности. Если время не задано, то задержка отправки равна 0 сек.
5.	При переходе на отправку чеков в систему лояльности по факту получения счетом признака полной оплаты рекомендуется однократно, в момент внедрения, выполнить скрипт 'create_lost_loyalty_checks.sql', который создаст недостающие чеки лояльности по чекам частичной оплаты (что обеспечит отправку в систему лояльности информации о начислении бонусов в полном объеме).
Создаваться чеки лояльности будут по следующему правилу:
*	FM_ACC_CHECK_ID = <текущий чек>,
*	FM_LOYALTY_ID = <значение системы лояльности по умолчанию>,
*	SYS_STATUS = 1,
*	WITH_LOYALTY = 0,
*	FM_ORG_ID = <ID филиала из FM_ACC_CHECK.MEDDEP>.
## Настройка значения идентификатора серии карт для системы ManzanaLoyalty
Протоколом информационного обмена с системой ManzanaLoyalty предусматривается, что значение параметра внешнего идентификатора задания на выпуск карт в запросе выпуска карты лояльности должно быть настраиваемым на стороне МО. Для настройки значения параметра предусмотрен системный параметр **FM_LOYALTY_IDEMISSIONTAS**K (пункт меню **Настройки / Системные параметры**).

| Проблема | Описание проблемы | Решение |
|----------|----------|----------|
| Сообщение при открытии окна: "Отсутствует лицензия POS-терминал"    | На рабочее место не была выдана лицензия "POS-терминал", при этом в системном параметре FM_POS_DEFAULT указано ненулевое значение   | 1. Если на данном рабочем месте предполагается работа с POS-терминалом, администратор МИС МЕДИАЛОГ должен выдать соответствующую лицензию в PMTLics. 2. Если работа с POS-терминалом не предполагается – администратор МИС МЕДИАЛОГ должен изменить настройки параметра FM_POS_DEFAULT
|

> [!NOTE]  
> Это примечание.
